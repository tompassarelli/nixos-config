#+TITLE: Tom's NixOS Configuration
#+AUTHOR: Tom
#+DATE: 2025-11-27

* Overview

This is a Level 4 NixOS configuration featuring:
- **Flakes** for reproducible builds
- **Multi-host** management (whiterabbit + thinkpad-x1e)
- **Custom module system** with ~myConfig.*~ namespace
- **Out-of-store symlinks** for live config editing
- **home-manager** integration

* Active Development

See [[file:todo.org][todo.org]] for current tasks and planned improvements.

* Quick Start

** Rebuild System
#+begin_src bash
rebuild              # Auto-detects hostname
rebuild whiterabbit  # Explicit host
#+end_src

** Update Dependencies
#+begin_src bash
nix flake update     # Update flake.lock
rebuild              # Apply updates
#+end_src

** Add a New Module
1. Create ~modules/my-app/default.nix~
2. Add option in ~default.nix~
3. Implement in ~my-app.nix~
4. Enable in ~hosts/whiterabbit/configuration.nix~

* Project Structure

#+begin_src
.
├── flake.nix                    # Flake inputs, outputs, mkSystem builder
├── hosts/                       # Per-host configurations
│   ├── whiterabbit/             # Framework 13 laptop
│   └── thinkpad-x1e/            # Old laptop
├── modules/                     # Feature modules (myConfig.*)
│   ├── niri/                    # Window manager
│   ├── shell/                   # Fish shell
│   ├── neovim/                  # Editor
│   └── ...                      # 40+ modules
├── dotfiles/                    # Out-of-store configs (live editing)
│   ├── niri/config.kdl
│   ├── doom/
│   └── ...
└── manual/                      # Deep-dive documentation
    ├── nix-basics.org           # /nix/store, levels, git+generations
    ├── module-system.org        # Fixpoint eval, types, options
    └── applications.org         # App-specific tips (niri, walker)
#+end_src

* Documentation

** For Understanding NixOS
→ [[file:manual/nix-basics.org][manual/nix-basics.org]]
- How /nix/store works
- Why you can't edit /etc
- mkOutOfStoreSymlink explained
- Configuration complexity levels (0-5)
- Where you are vs where you started

** For Understanding the Module System
→ [[file:manual/module-system.org][manual/module-system.org]]
- Fixpoint evaluation
- Type system and merge semantics
- specialArgs vs module options
- Why module options are superior

** For Application-Specific Notes
→ [[file:manual/applications.org][manual/applications.org]]
- Niri (window manager tips, Minecraft compatibility)
- Walker (activation mode, why walker over anyrun)

** For Architecture Details

*** Module Patterns
*Simple modules* (e.g., ~git/~, ~btop/~): Single ~default.nix~ with one feature

*Complex modules* (e.g., ~web-browser/~):
- ~default.nix~: Declares options, imports sub-modules
- ~firefox.nix~, ~fennec.nix~, ~chrome.nix~: Implement variants
- Allows multiple related features in one namespace

*** Configuration Flow
1. Host config sets enable flags (~myConfig.*.enable = true~)
2. Modules activate via ~lib.mkIf cfg.enable~
3. Generated configs → ~/nix/store~ (immutable)
4. Hand-written configs → ~dotfiles/~ (live via mkOutOfStoreSymlink)

*** Package Sources
- **Stable** (~pkgs.*~): nixpkgs 25.05
- **Unstable** (~pkgs.unstable.*~): nixpkgs-unstable overlay
- **Flake inputs**: walker, elephant (not in nixpkgs)
- **NUR**: Firefox addons, community packages

Update: ~nix flake update~

* Common Tasks

** Enable a new feature
#+begin_src nix
# hosts/whiterabbit/configuration.nix
{
  myConfig.steam.enable = true;  # Add this line
}
#+end_src

#+begin_src bash
rebuild
#+end_src

** Edit live configs (no rebuild needed)
#+begin_src bash
vim ~/code/nixos-config/dotfiles/niri/config.kdl
# Changes take effect immediately (out-of-store symlink)
#+end_src

** Rollback
#+begin_src bash
# Boot menu: select old generation
# OR
sudo nixos-rebuild switch --rollback
#+end_src

* Git + NixOS Workflow

** Best Practice
1. Make changes to config
2. ~rebuild~ (test it works)
3. If successful: ~gita && gitc && gitp~ (commit and push)
4. Never commit broken configs

** Why This Matters
- Git = your config source (recipes)
- NixOS generations = built systems (frozen meals)
- Booting old generation ≠ old git state
- Always commit after successful rebuild to keep them in sync

See [[file:manual/nix-basics.org::*Git + NixOS Workflow][manual/nix-basics.org]] for full explanation of git, generations, and btrfs.

* Inspirations

This config draws inspiration from:
- [[https://github.com/fufexan/dotfiles][fufexan/dotfiles]]
- [[https://github.com/redyf/nixdots][redyf/nixdots]]
- [[https://github.com/eduardofuncao/nixferatu][eduardofuncao/nixferatu]]

* License

MIT
